
架构师之路精选
====================

#### 互联网架构如何实现“高并发”
* 什么是高并发：通过设计保证系统能够同时并行处理很多请求
  - 相关指标：响应时间、吞吐量、QPS
* 如何提升并发能力
  - 垂直扩展（Scale Up）：业务发展前期建议使用（效果最快）
    - 提升单机处理能力：
      - 增强硬件：增加CPU数、升级网卡、升级硬盘、内存
      - 增强架构性能：缓存减少IO，异步增加吞吐量、无锁数据结构减少响应时间
  - 水平扩展(Scale Out)：终极方案
    - 常见互联网分层架构：客户端层、反向代理层、站点应用层、服务层、数据-缓存层、数据-数据库层
    - 分层水平扩展实践
      - 反向代理层：DNS轮询
      - 站点层：通过nginx实现，设置多个web后端
      - 服务层：通过服务连接池实现
      - 数据层：垂直拆分、水平拆分（按范围拆、按哈希拆）
        
#### TCP接入层的负载均衡、高可用、扩展性架构
* TCP是有状态的连接，一个client发起的请求必须落在同一台tcp-server上，如何做负载均衡，如何保证水平扩展呢
  - 单机法tcp-server：
    - 优点：请求一致性
    - 缺点：无法保证高可用
  - 集群法tcp-server，客户端实现负载均衡（配置多个外网IP，随机选择其一）
    - 优点：可保证高可用
    - 缺点：多一次DNS访问，难以预防DNS劫持
      - 改进：将IP配置在客户端（IP直通车）
        - 缺点：扩展性差，如IP变化、新增都需要更新客户端
  - 服务端实施负载均衡（根本上解决问题）
    - 增加一个http接口，将客户端的“IP配置”与“均衡策略”放到服务端，client每次访问tcp-server前，先调用一个新增的get-tcp-ip接口，这个http接口只返回一个tcp-server的IP
      - 优点：解决扩展性问题
      - 缺点：接口不知道tcp-server集群中每台服务器是否可用
  - tcp-server状态上报
    - 优点：解决上面问题
    - 缺点：反向依赖
  - tcp-server状态拉取
    - 优点：解决上面问题
    
#### 跨公网调用的大坑与架构优化方案
* 缘起
  - 业务需要跨公网调用一个第三方服务提供的接口，往往抽象出一个服务
  - 调用流程：1）业务方调用内部服务，2）内部服务跨公网调用三方，3）三方返回结果， 4）内部服务返回结果给业务方
    - 存在问题：某个调三方接口超时，会导致所有接口不可用
* 异步代理法
  - 异步代理服务定期跨公网调用三方服务，刷新本地数据
  - 优点：解决接口超时问题
  - 缺点：不是最新数据
* 第三方接口备份与切换法
  - 超时后调用第二个备份三方服务，直到超时服务恢复
  - 优点：解决超时问题
  - 缺点：不是所有三方有备用接口
* 异步调用法
  - 本地写成功就算成功，异步向第三方同步数据    
    
#### DNS在架构设计中的巧用
* 反向代理水平扩展
  - 配置多个nginx的外网IP，轮询返回
* web-server负载均衡（很少用）
  - 优点：第三方实施，不用改动架构；减少一层网络请求
  - 缺点：只具备解析功能，不保证IP的可用性（nginx做反向代理有保活探测机制，能自动迁移流量）；web-server扩容时，dns个性生效时间长
* 用户就近访问：智能DNS
  
#### 到底什么时候该使用MQ？
* 消息总线（Message Queue），后文称MQ，是一种跨进程的通信机制，用于上下游传递消息。
* 什么时候不使用MQ：上游实时关注执行结果
  - 缺点：1）系统更复杂，2）消息传递路径更长，延时增加，3）消息可靠性和重复性互相矛盾，4）上游无法知道下游执行结果
* 什么时候使用MQ
  - 场景一：数据驱动的任务依赖
    - 常规作法：cron定时执行
      - 缺点：1）超时问题严重；2）执行时间很长，预留大量buffer；3）依赖关系容易出错；4）调整一个任务影响很大
    - 优化方案：采用MQ解耦
      - 优点：1）不需要预留buffer；2）方便处理依赖；3）调整任务，不影响下游执行时间
  - 场景二：上游不关心执行结果
    - 优点：1）上游执行时间短；2）上下游逻辑解耦；3）新增下游，不用改上游
  - 场景三：上游关心执行结果，但执行时间很长
    - 三方服务，回调网关通知MQ  
  
#### 消息总线能否实现消息必达？
* MQ要想尽量消息必达，架构上有两个核心设计点：1）消息落地；2）消息超时、重传、确认

 
  
### 资料链接
* [架构师之路精选](https://mp.weixin.qq.com/s/CIPosICgva9haqstMDIHag)